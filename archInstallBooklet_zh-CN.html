<!DOCTYPE html>
<html>
    <head>
        <title>[教程]安装Arch</title>
        <meta http-equiv="Content-Type" content="charset=UTF-8">
        <style type="text/css">
            body{min-width: 600px;
                max-width: 800px;
				margin: 0 auto;
				padding: 10px;
                background-color: #e6e0ac;
                font-family:Arial, sans-serif;}
            header{margin: 10px 0;}
            h1,h2,h3{color:#e67b30;
                margin:0;}
            .note{border-left: 4px #e67b30 solid;
                padding: 0 10px;}
            .note *{color: #000;}
            .note strong{color: #F00;}
            a:link{color: #e67b30;}
            .steps{border: 2px #e67b30 dashed;
                border-radius: 16px;
                margin: 16px 0;
                padding: 10px 20px;}
            .step{color:#000;
                font-weight: bold;}
            .code{color: #e67b30;
                background-color: #ffffff22;
                display: inline-block;
                padding: 4px 8px;
                margin: 4px;
                border-radius: 8px;}
            table{border-collapse: separate;
                background-color: #ffffff33;
                padding: 4px;
                margin: 4px;
                border-radius: 8px;}
            tr,td,th {color: #000;
                padding: 2px 4px;
                text-align: left;}
            a,p{color: #000;
                font-size: 16px;
                display:inline;}
        </style>
    </head>
    <body>
        <header>
            <h1>安装Arch</h1>
        </header>
        <hr>
        <main>
            <div class="note">
                <p>
                    使用btrfs和加密的LVM<br>
                    在阅读本教程前,请确认电脑架构.<br>
                    由于是自用的关系,<strong>兼容性不会很高</strong>,请酌情使用相关配置.<br>
                    这是根据网上四篇教程总结出的,相关链接:
                    <div class="link">
                        <a href="https://www.viseator.com/2017/05/17/arch_install/">其一</a>
                        <a href="https://www.howtoing.com/how-to-install-arch-linux-with-full-disk-encryption/">其二</a>
                        <a href="https://blog.yangmame.org/在U盘安装加密的Linux系统.html">其三</a>
                        <a href="https://snowfrs.com/2019/08/10/intall-archlinux-with-btrfs.html">其四</a>
                    </div>
                    注意,全程假设目标硬盘是/dev/sda
                </p>
            </div>
            <div class="steps">
                <h2>前期准备</h2>
                <p>
                    请到<a href="https://www.archlinux.org/download">ArchLinux</a>官网下载光盘镜像,并写入到U盘/光盘上,并从UEFI启动.
                </p>
                <br>
                <p>
                    <a class="step">联网:</a><br>
                    <a class="code">dhcpcd</a>或着<a class="code">iwctl</a>
                    <div class="note"><p>后者请按照流程输入WiFi配置信息</p></div>
                    <a class="step">时间更新:</a><br>
                    <a class="code">timedatectl set-ntp true</a><br>
                    <a class="step">更新包管理器的配置:</a><br>
                    <a class="code">vim /etc/pacman.conf</a><br>
                    <div class="note">
                        <p>
                            取消注释
                            Misc options里的paralleldownloads = 5 来启用多线程下载,<br>
                            以及下面软件源中的[multilib]和接下来的一行链接
                        </p>
                    </div>
                    <a class="step">测试镜像服务器,并更新列表:</a><br>
                    <a class="code">reflector --save /etc/pacman.d/mirrorlist --protocol https --sort rate -a 6 -c china</a><br>
                    <a class="step">扫描并更新源:</a><br>
                    <a class="code">pacman -Syy</a>
                </p>
            </div>
            <div class="steps">
                <h2>准备磁盘</h2>
                <p>
                    <a class="step">查看磁盘:</a><br>
                    <a class="code">lsblk</a>
                    <div class="note"><p>硬盘一般来说是sd*,或者nvme*,前者sata或usb接口,后者nvme接口.</p></div>
                    <div class="note"><p><strong>注意,磁盘将被擦除,请在此之前做好数据备份.</strong></p></div>
                    <a class="step">擦除磁盘:</a><br>
                    <a class="code">shred --verbose --random-source=/dev/urandom --iterations=1 /dev/sda</a>
                    <div class="note"><p>这里iterations=1 指的是擦除1遍.时间可能会很长.固态硬盘1遍即可</p></div>
                </p>
            </div>
            <div class="steps">
                <h2>分区</h2>
                <p>
                    <div class="note">
                        <a class="step">概览:</a>
                        <table>
                            <tr>
                                <th>分区名称</th>
                                <th>逻辑卷名称</th>
                                <th>文件系统</th>
                                <th>安装时的挂载点</th>
                                <th>建议大小</th>
                            </tr>
                            <tr>
                                <td>/dev/sda1</td>
                                <td>/boot</td>
                                <td>vfat(FAT32)</td>
                                <td>/mnt/boot</td>
                                <td>256MB或以上</td>
                            </tr>
                            <tr>
                                <td>/dev/sda2</td>
                                <td>system</td>
                                <td>物理卷</td>
                                <td>不适用</td>
                                <td>剩余空间的大小,如果不需要额外的分区</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td>system-root</td>
                                <td>btrfs</td>
                                <td>/mnt</td>
                                <td>另外两个分区剩下的(最好大于20G)</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td>system-swap</td>
                                <td>swap</td>
                                <td>无</td>
                                <td>RAM大小或更大</td>
                            </tr>
                        </table>
                        <p>若需要挂起到硬盘则swap大小至少大于或等于ram大小,以防休眠到硬盘时出错.<br>如不需要,设置为ram的1/4即可.</p><br>
                        <table>
                            <tr>
                                <th>分区名称</th>
                                <th>例子(SSD,可用476.94GiB)</th>
                            </tr>
                            <tr>
                                <td>/dev/sda1</td>
                                <td>512MB(已用96.16MiB)</td>
                            </tr>
                            <tr>
                                <td>/dev/sda2</td>
                                <td>476.44GiB</td>
                            </tr>
                            <tr>
                                <td>system-root</td>
                                <td>444.4GiB(已用15.7GiB)</td>
                            </tr>
                            <tr>
                                <td>system-swap</td>
                                <td>32GiB</td>
                            </tr>
                        </table>
                    </div>
                    <a class="step">开始分区:</a><br>
                    <a class="code">cfdisk /dev/磁盘名</a>
                    <div class="note">
                        <p>
                            然后选择gpt分区,创建上表<br>
                            后期可通过<a class="code">mkswap [文件路径]</a>和<a class="code">swapon [文件路径]</a>指令创建和激活swap文件.
                        </p>
                        <a>分区后:(虚拟机)</a><br>
                        <a>运行<a class="code">lsblk</a>后即可看到下图(部分省略)</a><br>
                        <table>
                            <tr>
                                <th>NAME</th>
                                <th>SIZE</th>
                                <th>TYPE</th>
                            </tr>
                            <tr>
                                <td>sda</td>
                                <td>476.9G</td>
                                <td>disk</td>
                            </tr>
                            <tr>
                                <td>┣sda1</td>
                                <td>512M</td>
                                <td>part</td>
                            </tr>
                            <tr>
                                <td>┗sda2</td>
                                <td>476.4G</td>
                                <td>part</td>
                            </tr>
                        </table>
                    </div>
                </p>
            </div>
            <div class="steps">
                <h2>配置分区</h2>
                <p>
                    <p class="step">新建加密分区:</p>
                    <a class="code">cryptsetup -c aes-xts-plain64 -s 512 -h sha512 -i 8192 --use-urandom luksFormat --type=luks2 /dev/sda2</a>
                    <p>
                        <a class="step">打开lvm卷:</a><br>
                        <a class="code">cryptsetup open --type luks /dev/sda2 cryptlvm</a><br>
                        <a class="step">创建物理卷:</a><br>
                        <a class="code">pvcreate /dev/mapper/cryptlvm</a><br>
                        <a class="step">创建System组:</a><br>
                        <a class="code">vgcreate system /dev/mapper/cryptlvm</a><br>
                        <a class="step">创建根分区:</a><br>
                        <a class="code">lvcreate -L ▲G system -n root</a><br>
                        <a class="step">创建swap分区:</a><br>
                        <a class="code">lvcreate -L ▮G system -n swap</a><br>
                        <div class="note">
                            ▲是root分区大小;<br>
                            ▮是swap大小.</p>
                        </div>
                    </p>
                </p>
            </div>
            <div class="steps">
                <h2>格式化/挂载</h2>
                <p>
                    <div class="note">
                        <table>
                            <thead>
                                <p>子卷挂载列表,酌情创建:</p>
                            </thead>
                            <tr>
                                <td>子卷名[顺序:自上而下]</td>
                                <td>位置</td>
                            </tr>
                            <tr>
                                <td>@</td>
                                <td>/mnt</td>
                            </tr>
                            <tr>
                                <td>@home</td>
                                <td>/mnt/home</td>
                            </tr>
                            <tr>
                                <td>@logs</td>
                                <td>/mnt/var/log</td>
                            </tr>
                            <tr>
                                <td>@tmp</td>
                                <td>/mnt/tmp</td>
                            </tr>
                            <tr>
                                <td>@docker</td>
                                <td>/mnt/var/lib/docker</td>
                            </tr>
                            <tr>
                                <td>@pkgs</td>
                                <td>/mnt/var/cache/pacman</td>
                            </tr>
                            <tr>
                                <td>@build</td>
                                <td>/mnt/var/lib/build</td>
                            </tr>
                            <tr>
                                <td>@snapshots</td>
                                <td>/mnt/.snapshots</td>
                            </tr>
                        </table>
                        <table>
                            <thead>
                                <p>硬盘优化选项(多选)</p>
                            </thead>
                            <tr>
                                <td>必选</td>
                                <td>noatime,nodiratime</td>
                            </tr>
                            <tr>
                                <td>ssd</td>
                                <td>compress=zstd,ssd,discard=async</td>
                            </tr>
                            <tr>
                                <td>hhd</td>
                                <td>compress-force=zstd,autodefrag</td>
                            </tr>
                        </table>
                    </div>
                    <a class="step">格式化:</a><br>
                    <a class="code">
                        mkfs -t vfat -F 32 /dev/sda1<br>
                        mkfs -t btrfs /dev/mapper/system-root<br>
                        mkswap /dev/mapper/system-swap
                    </a><br>
                    <a class="step">开启swap分区:</a><br>
                    <a class="code">swapon /dev/mapper/system-swap</a><br>
                    <a class="step">挂载btrfs根分区并创建子分区:</a><br>
                    <a class="code">mount -o [优化选项] /dev/mapper/system-root /mnt</a><br>
                    <a class="step">创建子分区:</a><br>
                    <a class="code">btrfs subvolume create /mnt/[子卷名]</a><br>
                    <a class="step">卸载:</a><br>
                    <a class="code">umount /mnt</a><br>
                    <a class="step">挂载btrfs根分区:</a><br>
                    <a class="code">mount -o [优化选项],subvol=@ /dev/mapper/system-root /mnt</a><br>
                    <a class="step">创建子卷目录:</a><br>
                    <a class="code">mkdir -p /mnt/{btrfs-root,boot,home,var/{log,lib/{docker,build},cache/pacman},tmp}</a><br>
                    <a class="step">挂载子卷:</a><br>
                    <a class="code">
                        mount -o [优化选项],subvol=[子卷名] /dev/mapper/system-root [位置]<br> 
                        mount -o [优化选项],subvol=/ /dev/mapper/system-root /mnt/btrfs-root
                    </a><br>
                    <a class="step">创建boot分区,并挂载:</a><br>
                    <a class="code">
                        mount /dev/sda1 /mnt/boot<br>
                        mkdir -p /mnt/boot/EFI
                    </a>
                    <br>
                    <div class="note">
                        <a>按需创建并挂载后:</a><br>
                        <a class="code">lsblk</a><a>(部分省略)</a>
                        <table>
                            <tr>
                                <th>NAME</th>
                                <th>SIZE</th>
                                <th>TYPE</th>
                                <th>MOUNTOPTIONS</th>
                            </tr>
                            <tr>
                                <td>sda</td>
                                <td>476.9G</td>
                                <td>disk</td>
                            </tr>
                            <tr>
                                <td>┣sda1</td>
                                <td>512M</td>
                                <td>part</td>
                                <td>/mnt/boot</td>
                            </tr>
                            <tr>
                                <td>┗sda2</td>
                                <td>476.4G</td>
                                <td>part</td>
                            </tr>
                            <tr>
                                <td>&nbsp;&nbsp;┗cryptlvm</td>
                                <td>476.4G</td>
                                <td>crypt</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td rowspan="3">&nbsp;&nbsp;&nbsp;&nbsp;┣system-root<br>&nbsp;&nbsp;&nbsp;&nbsp;┃<br>&nbsp;&nbsp;&nbsp;&nbsp;┃<br>&nbsp;&nbsp;&nbsp;&nbsp;┃</td>
                                <td>444.4G</td>
                                <td>lvm</td>
                                <td>/mnt/btrfs-root</td>
                            </tr>
                            <tr>
                                <td colspan="2"></td>
                                <td><a>/mnt/home</a></td>
                            </tr>
                            <tr>
                                <td colspan="2"></td>
                                <td><a>/mnt</a></td>
                            </tr>
                            <tr>
                                <td>&nbsp;&nbsp;&nbsp;&nbsp;┗system-swap</td>
                                <td>32G</td>
                                <td>lvm</td>
                                <td>[SWAP]</td>
                            </tr>
                        </table>
                    </div>
                </p>
            </div>
            <div class="steps">
                <h2>安装</h2>
                <p>
                    <a class="step">安装基本系统:</a>
                    <a class="code">pacstrap -i /mnt base base-devel linux linux-firmware vim lvm2 snapper dhcpcd grub grub-btrfs efibootmgr networkmanager network-manager-applet wpa_supplicant os-prober ntfs-3g</a>
                    <div class="note">
                        <a>可选在同时安装kde桌面:</a><br>
                        <a>在上述命令后加上:</a>
                        <a class="code">plasma kde-applications</a>
                    </div>
                    <div class="note">
                        <a>可选在同时安装clamav防毒软件本体和防毒软件前端:</a><br>
                        <a>在上述命令后加上:</a>
                        <a class="code">clamav clamtk</a>
                    </div>
                    <a class="step">创建fstab文件,用于开机时挂载分区</a><br>
                    <a class="code">genfstab -U -p /mnt >> /mnt/etc/fstab</a>
                </p>
            </div>
            <div class="steps">
                <h2>配置</h2>
                <p>
                    <a class="step">改变根目录:</a><br>
                    <a class="code">arch-chroot /mnt</a>
                    <div class="note">
                        <a>如果安装了kde桌面请务必执行:(注意大小写)</a><br>
                        <a class="code">
                            systemctl enable NetworkManager sddm<br>
                            pacman -S archlinux-appstream-data packagekit-qt5 flatpak fwupd
                        </a>
                    </div>

                    <a class="step">配置地区设置:</a><br>
                    <a class="code">vim /etc/locale.gen</a><br>
                    <div class="note"><a>取消注释en_US.UTF-8和zh_CN.UTF-8 退出</a></div>
                    <a class="step">应用地区设置:</a><br>
                    <a class="code">locale-gen</a><br>
                    <a class="step">设置语言:</a><br>
                    <a class="code">echo LANG=en_US.UTF-8 > /etc/locale.conf</a><br>
                    <a class="step">设置时区:</a><br>
                    <a class="code">ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</a><br>
                    <a class="step">设置root密码:</a><br>
                    <a class="code">passwd root</a><br>
                    <a class="step">设置主机名:</a><br>
                    <a class="code">echo △ > /etc/hostname</a><br>
                    <div class="note"><p>△是想设置的主机名</p></div>
                    <a class="step">添加用户:</a><br>
                    <a class="code">useradd -m -g users -G wheel,games,power,optical,storage,scanner,lp,audio,video -s /bin/bash ▢</a><br>
                    <a class="step">更改新用户密码:</a><br>
                    <a class="code">passwd ▢</a><br>
                    <div class="note"><p>▢是被创建的用户名称</p></div>
                    <a class="step">让wheel组用户可以使用sudo:</a><br>
                    <a class="code">EDITOR=vim visudo</a>
                    <a>取消注释 %whell all=(all) all</a><br>
                    <a>记下加密物理卷的UUID</a><br>
                    <a class="code">blkid</a><br>
                    <div class="note"><p>是带有'TYPE="crypto_LUKS"'的分区,请不要和其它分区的UUID混淆.</p></div>
                    <a class="step">配置grub:</a><br>
                    <a class="code">vim /etc/default/grub</a><br> 
                    <a class="step">取消注释</a>
                    <a class="code">GRUB_ENABLE_CRYPTODISK=y</a><br> 
                    <a>并在GRUB_CMDLINE_LINUX=""的双引号间加入：</a><br>
                    <a class="code">cryptdevice=UUID=◯:cryptlvm root=/dev/system/root resume=/dev/system/swap</a><br>
                    <div class="note"><p>◯是刚刚记下的UUID</p></div>
                    <a class="step">配置内核:</a><br>
                    <a class="code">vim /etc/mkinitcpio.conf</a><br>
                    <a>在MODULES=(...)里加入<strong>btrfs</strong>,</a><br>
                    <a>在HOOKS=(...)加入 <strong>keyboard,keymap,encrypt,lvm2,resume</strong>和替换<strong>fsck</strong>为<strong>btrfs</strong>(注意顺序)</a><br>
                    <div class="note">
                        <p>
                            例子:<br>
                            HOOKS=(base udev autodetect <strong>keyboard</strong> <strong>keymap</strong> modconf block <strong>encrypt</strong> <strong>lvm2</strong> <strong>resume</strong> filesystems <strong>btrfs</strong>)<br>
                            如果是笔记本等设备 在/etc/systemd/logind.conf里添加"HandleLidSwitch=hibernate".
                        </p>
                    </div>
                    <a class="step">制作内核:</a><br>
                    <a class="code">mkinitcpio -p linux</a><br>
                    <a class="step">安装引导:</a><br>
                    <a class="code">grub-install --efi-directory=/boot/EFI --boot-directory=/boot --bootloader-id=◇ --recheck --removable</a><br>
                    <div class="note"><p>◇是给efi启动选项的名字,不弄也可.</p></div>
                    <a class="step">导出启动配置:</a><br>
                    <a class="code">grub-mkconfig --o /boot/grub/grub.cfg</a><br>
                    <a class="step">退出chroot:</a><br>
                    <a class="code">exit</a><br>
                    <a class="step">重启:</a><br>
                    <a class="code">reboot</a><br>
                    <a class="step">重启后 设置硬件时钟:</a><br>
                    <a class="code">hwclock --systohc --utc</a><br>
                    <a class="step">重启后 设置使用网络时间:</a><br>
                    <a class="code">timedatectl set-ntp true</a><br>
                </p>
                <h3>至此 你的电脑应该能正常使用了,欢迎使用Arch.</h3>
                <div class="note">
                    <a>重启后,如果在在上面步骤安装了clamav,请务必执行:</a><br>
                    <a class="code">
                        systemctl enable clamav-daemon <br>
                        systemctl start clamav-daemon
                    </a>
                </div>
            </div>
            <div class="steps">
                <h2 style="width: 100%;">附录</h2>
                <h3>系统相关</h3>
                <a>▷显卡驱动</a><br>
                <a>intel</a><br>
                <a class="code">sudo pacman -S xf86-video-intel</a><br>
                <a>nvidia</a><br>
                <a class="code">sudo pacman -S xf86-video-nouveau</a><br>
                <a>ATI</a><br>
                <a class="code">sudo pacman -S xf86-video-amdgpu</a><br>
                <a>▷处理器微码(Microcode) </a><br>
                <a>AMD</a><br>
                <a class="code">pacman -S amd-ucode</a><br>
                <a>Intel</a><br>
                <a class="code">pacman -S intel-ucode</a><br>
                <a>▷快照</a><br>
                <a style="font-style: italic;">根据自己的subvolume实际情况创建snapshot策略</a><br>
                <a>创建配置文件:</a><br>
                <a class="code">snapper -c [名字] create-config [子卷的目录]</a><br>
                <a>编辑配置文件:</a><br>
                <a class="code">vim /etc/snapper/configs/[已经创建的名字]</a><br>
                <a>列出配置文件:</a><br>
                <a class="code">snapper list-configs</a><br>
                <a>撤回:</a><br>
                <a class="code">snapper -c [名字] undochange [起始快照编号]..[目标快照编号]</a><br>
                <a>启用自动创建/清理功能:</a><br>
                <a class="code">
                    systemctl enable --now snapper-timeline.timer<br>
                    systemctl enable --now snapper-cleanup.timer
                </a><br>
                <h3>软件相关</h3>
                <a>▷AUR(用户软件库)</a><br>
                <a class="code">git clone https://aur.archlinux.org/yay.git</a><br>
                <a class="code">cd yay</a><br>
                <a class="code">makepkg -si</a><br>
                <a>▷fcitx输入法和字体</a><br>
                <a class="code">pacman -S noto-fonts-cjk fcitx fcitx-im kcm-fcitx</a><br>
                <div class="note"><p>kcm-fcitx是图形化配置程序.</p></div>
                <a>在/etc/profile文件,在文件开头加入三行:</a><br>
                <a class="code">
                    export XMODIFIERS="@im=fcitx"<br>
                    export GTK_IM_MODULE="fcitx"<br>
                    export QT_IM_MODULE="fcitx"
                </a><br>
                <a>▷vscode</a><br>
                <a class="code">yay -S code</a><br>
                <a>▷v2ray(梯子) </a><br>
                <a class="code">yay -S v2raya</a><br>
                <a>▷Yakuake(下拉式终端)</a><br>
                <a class="code">pacman -S yakuake</a><br>
                <a>▷Zsh(Shell)</a><br>
                <a class="code">yay -S zsh</a><br>
                <a class="code">chsh -s /bin/zsh</a>
                <a>或</a>
                <a class="code">vim /etc/passwd</a>
                <a>编辑默认shell.</a>
                <div class="note"><p>可选oh-my-zsh-git<br><a class="code">yay -S oh-my-zsh-git</a></p></div>
                <a>▷VirtualBox 虚拟机</a><br>
                <a class="code">pacman -S virtualbox virtualbox-ext-vnc virtualbox-guest-iso virtualbox-host-modules-arch linux-headers</a><br>
                <div class="note">
                    <a>VirtualBox 扩展安装后:</a><br>
                    <a class="code">sudo usermod -a -G vboxusers [用户名]</a><br>
                </div>
            </div>
        </main>
        <footer>
            <p>
                更新于2022/10/22<br>
                By NoName_3031@2022Oct
            </p>
        </footer>
    </body>
</html>
